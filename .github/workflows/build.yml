name: Build

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build and analyze
    runs-on: ubuntu-latest

    services:
      sonarqube:
        image: sonarqube:9.9-community
        ports:
          - 9000:9000

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Wait for SonarQube to be ready
        run: |
          echo "Waiting for SonarQube (up to ~5m)"
          for i in $(seq 1 60); do
            body=$(curl -sS http://localhost:9000/api/system/health 2>/dev/null || true)
            if echo "$body" | grep -q '"status":"UP"'; then
              echo "SonarQube is UP"
              break
            fi
            body=$(curl -sS http://localhost:9000/api/server/health 2>/dev/null || true)
            if echo "$body" | grep -q '"status":"UP"'; then
              echo "SonarQube is UP (server/health)"
              break
            fi
            version=$(curl -sS http://localhost:9000/api/server/version 2>/dev/null || true)
            if [ -n "$version" ]; then
              echo "SonarQube responding, version: $version"
              break
            fi
            echo "Attempt $i: Sonar not ready yet"
            sleep 5
          done
          if [ "$i" -eq 60 ]; then
            echo "ERROR: SonarQube did not become ready"
            curl -v http://localhost:9000 || true
            exit 1
          fi

      - name: Build and analyze
        env:
          SONAR_HOST_URL: http://localhost:9000
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B -Dsonar.host.url="$SONAR_HOST_URL" -Dsonar.login="$SONAR_TOKEN" \
            verify org.sonarsource.scanner.maven:sonar-maven-plugin:5.3.0.6276:sonar \
            -Dsonar.projectKey=Diego-Arreola_CleanTeam_aad8b470-b1c6-4f47-8397-7ad49885fd87 \
            -Dsonar.projectName='CleanTeam'
                          echo "SonarQube responding, version: $version"
